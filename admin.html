<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NaivaCom Admin</title>
    <link rel="stylesheet" href="styles/general.css" />
    <link rel="stylesheet" href="styles/home.css" />
    <script defer src="scripts/home.js"></script>
    <style>
      main {
        max-width: 1000px;
        margin: 40px auto;
        padding: 20px;
        background: rgba(26, 34, 46, 0.5);
        backdrop-filter: blur(8px) saturate(120%);
        -webkit-backdrop-filter: blur(8px) saturate(120%);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
      }
      .list {
        display: grid;
        gap: 8px;
      }
      .list .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
      }
      .row .meta {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .thumb {
        width: 56px;
        height: 40px;
        object-fit: cover;
        border-radius: 6px;
        display: inline-block;
      }
      /* modal styles */
      #admin-view-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      #admin-view-modal .overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
      }
      #admin-view-modal .dialog {
        position: relative;
        max-width: 880px;
        width: 95%;
        background: rgba(26, 34, 46, 0.85);
        color: #fff;
        padding: 18px;
        border-radius: 12px;
        z-index: 10001;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 12px;
      }
      #admin-view-modal img.preview {
        width: 100%;
        height: auto;
        max-height: 420px;
        object-fit: cover;
        border-radius: 10px;
      }
      #admin-view-modal .dialog .meta {
        font-size: 0.95rem;
        color: var(--muted);
      }
      #admin-view-modal .closeBtn {
        position: absolute;
        right: 10px;
        top: 8px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #fff;
        padding: 6px 8px;
        border-radius: 8px;
        cursor: pointer;
      }
      .row button {
        background: #d9534f;
      }
      /* light-mode admin overrides */
      html.light main {
        background: rgba(255, 255, 255, 0.9);
        color: #0b1220;
        border: 1px solid rgba(10, 10, 10, 0.06);
      }
      html.light .list .row {
        background: rgba(255, 255, 255, 0.88);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      html.light #pw-form {
        background: rgba(255, 255, 255, 0.95) !important;
        color: #0b1220;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Admin — Content Manager</h1>
      <div
        id="edit-controls"
        style="
          display: flex;
          gap: 12px;
          align-items: center;
          margin-bottom: 12px;
        "
      >
        <button
          id="toggle-edit"
          style="
            background: #2b6be6;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
          "
        >
          Enable Editing
        </button>
        <span id="edit-status" style="color: var(--muted)"
          >Editing is disabled — view-only</span
        >
      </div>
      <section id="admin-services">
        <h2>Services</h2>
        <form id="service-form">
          <input name="title" placeholder="Title" required />
          <input name="image" placeholder="Image path (optional)" />
          <textarea
            name="description"
            placeholder="Short description"
          ></textarea>
          <button type="submit">Add Service</button>
        </form>
        <div class="list" id="admin-services-list"></div>
      </section>

      <section id="admin-testimonials">
        <h2>Testimonials</h2>
        <form id="testimonial-form">
          <input name="name" placeholder="Name" required />
          <input name="role" placeholder="Role / Company" />
          <textarea name="comment" placeholder="Comment" required></textarea>
          <button type="submit">Add Testimonial</button>
        </form>
        <div class="list" id="admin-testimonials-list"></div>
      </section>

      <section id="admin-projects">
        <h2>Projects</h2>
        <form id="project-form">
          <input name="title" placeholder="Project title" required />
          <input name="image" placeholder="Image path (optional)" />
          <input name="link" placeholder="External link (https://...)" />
          <textarea
            name="description"
            placeholder="Short description"
          ></textarea>
          <button type="submit">Add Project</button>
        </form>
        <div class="list" id="admin-projects-list"></div>
      </section>

      <button id="clear-data" style="margin-top: 24px; background: #c9302c">
        Clear all saved data
      </button>
    </main>

    <!-- Password gate overlay -->
    <div
      id="pw-gate"
      style="
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
      "
    >
      <form
        id="pw-form"
        style="
          background: rgba(26, 34, 46, 0.6);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          padding: 20px;
          border-radius: 12px;
          min-width: 320px;
          display: flex;
          flex-direction: column;
          gap: 12px;
        "
      >
        <h2>Admin Login</h2>
        <input
          id="pw-input"
          type="password"
          placeholder="Enter admin password"
          autofocus
        />
        <div style="display: flex; gap: 8px; justify-content: flex-end">
          <button type="submit">Enter</button>
        </div>
        <p style="font-size: 0.9rem; color: var(--muted)">
          Hint: contact site owner
        </p>
        <p id="pw-error" style="color: #f66; display: none; margin: 0"></p>
      </form>
    </div>

    <script>
      // small admin wiring to App (exposed by scripts/home.js)
      document.addEventListener("DOMContentLoaded", () => {
        // password gate logic
        const gate = document.getElementById("pw-gate");
        const pwForm = document.getElementById("pw-form");
        const pwInput = document.getElementById("pw-input");
        const pwError = document.getElementById("pw-error");
        const AUTH_KEY = "naivacom-admin-auth";

        function isAuthed() {
          return sessionStorage.getItem(AUTH_KEY) === "1";
        }
        function unlock() {
          gate.style.display = "none";
        }
        function lock() {
          gate.style.display = "flex";
        }

        if (isAuthed()) unlock();

        pwForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const val = pwInput.value || "";
          if (val === "komoKomo") {
            sessionStorage.setItem(AUTH_KEY, "1");
            unlock();
          } else {
            pwError.style.display = "block";
            pwError.textContent = "Wrong password";
            setTimeout(() => (pwError.style.display = "none"), 2000);
          }
        });

        const svcForm = document.getElementById("service-form");
        const svcList = document.getElementById("admin-services-list");
        const projForm = document.getElementById("project-form");
        const projList = document.getElementById("admin-projects-list");
        const testForm = document.getElementById("testimonial-form");
        const testList = document.getElementById("admin-testimonials-list");
        const clearBtn = document.getElementById("clear-data");
        const toggleEditBtn = document.getElementById("toggle-edit");
        const editStatus = document.getElementById("edit-status");

        // editing is disabled by default; require explicit enable
        let editEnabled =
          sessionStorage.getItem("naivacom-edit-enabled") === "1";

        function setEditMode(on) {
          editEnabled = !!on;
          sessionStorage.setItem(
            "naivacom-edit-enabled",
            editEnabled ? "1" : "0"
          );
          // enable/disable forms
          [svcForm, testForm, projForm].forEach((f) => {
            if (!f) return;
            Array.from(f.querySelectorAll("input,textarea,button")).forEach(
              (el) => {
                // keep the toggle button unaffected
                if (el.id === "toggle-edit") return;
                el.disabled = !editEnabled;
              }
            );
          });
          // show status
          editStatus.textContent = editEnabled
            ? "Editing enabled — you can add/delete content"
            : "Editing is disabled — view-only";
          toggleEditBtn.textContent = editEnabled
            ? "Disable Editing"
            : "Enable Editing";
          // show or hide delete buttons
          document.querySelectorAll(".row button[data-id]").forEach((b) => {
            b.style.display = editEnabled ? "inline-block" : "none";
          });
        }

        // initialize edit mode UI
        setEditMode(editEnabled);

        function renderLists() {
          svcList.innerHTML = "";
          (App.getServices() || []).forEach((s) => {
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `
              <div class="meta">
                <img class="thumb" src="${
                  s.image || "images/webDevcard.webp"
                }" alt="${s.title}"/>
                <div>
                  <strong>${s.title}</strong>
                  <div style="font-size:0.9rem;color:var(--muted);">${
                    s.description || ""
                  }</div>
                </div>
              </div>
              <div>
                <button class="viewBtn" data-type="service" data-id="${
                  s.id
                }">View</button>
                <button data-id="${s.id}">Delete</button>
              </div>`;
            svcList.appendChild(row);
          });

          testList.innerHTML = "";
          (App.getTestimonials() || []).forEach((t) => {
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `
              <div class="meta">
                <div>
                  <strong>${t.name}</strong>
                  <div style="font-size:0.9rem;color:var(--muted);">${
                    t.role || ""
                  }</div>
                </div>
              </div>
              <div>
                <button class="viewBtn" data-type="testimonial" data-id="${
                  t.id
                }">View</button>
                <button data-id="${t.id}">Delete</button>
              </div>`;
            testList.appendChild(row);
          });

          projList.innerHTML = "";
          (App.getProjects() || []).forEach((p) => {
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `
              <div class="meta">
                <img class="thumb" src="${
                  p.image || "images/webDevcard.webp"
                }" alt="${p.title}"/>
                <div>
                  <strong>${p.title}</strong>
                  <div style="font-size:0.9rem;color:var(--muted);">${
                    p.description || ""
                  }</div>
                </div>
              </div>
              <div>
                <button class="viewBtn" data-type="project" data-id="${
                  p.id
                }">View</button>
                <button data-id="${p.id}">Delete</button>
              </div>`;
            projList.appendChild(row);
          });
        }

        svcForm.addEventListener("submit", (e) => {
          e.preventDefault();
          if (!editEnabled) {
            alert("Enable editing to add content");
            return;
          }
          if (!confirm("Confirm adding this service?")) return;
          const fd = new FormData(svcForm);
          const item = {
            id: Date.now(),
            title: fd.get("title"),
            image: fd.get("image") || "images/webDevcard.webp",
            description: fd.get("description"),
          };
          App.addService(item);
          svcForm.reset();
          renderLists();
        });

        testForm.addEventListener("submit", (e) => {
          e.preventDefault();
          if (!editEnabled) {
            alert("Enable editing to add content");
            return;
          }
          if (!confirm("Confirm adding this testimonial?")) return;
          const fd = new FormData(testForm);
          const item = {
            id: Date.now(),
            name: fd.get("name"),
            role: fd.get("role"),
            comment: fd.get("comment"),
          };
          App.addTestimonial(item);
          testForm.reset();
          renderLists();
        });

        projForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const fd = new FormData(projForm);
          const item = {
            id: Date.now(),
            title: fd.get("title"),
            image: fd.get("image") || "images/webDevcard.webp",
            link: fd.get("link") || "",
            description: fd.get("description") || "",
          };
          App.addProject(item);
          projForm.reset();
          renderLists();
        });

        svcList.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (!id) return;
          if (!editEnabled) {
            alert("Enable editing to delete content");
            return;
          }
          if (!confirm("Delete this service? This action cannot be undone."))
            return;
          App.deleteService(Number(id));
          renderLists();
        });
        testList.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (!id) return;
          if (!editEnabled) {
            alert("Enable editing to delete content");
            return;
          }
          if (
            !confirm("Delete this testimonial? This action cannot be undone.")
          )
            return;
          App.deleteTestimonial(Number(id));
          renderLists();
        });
        projList.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (!id) return;
          if (!editEnabled) {
            alert("Enable editing to delete content");
            return;
          }
          if (!confirm("Delete this project? This action cannot be undone."))
            return;
          App.deleteProject(Number(id));
          renderLists();
        });

        clearBtn.addEventListener("click", () => {
          if (confirm("Clear stored data?")) {
            localStorage.removeItem("naivacom-services");
            localStorage.removeItem("naivacom-testimonials");
            localStorage.removeItem("naivacom-projects");
            location.reload();
          }
        });

        // toggle edit permission button
        toggleEditBtn.addEventListener("click", () => {
          if (editEnabled) {
            if (confirm("Disable editing?")) setEditMode(false);
            return;
          }
          // require confirmation to enable edits
          if (
            confirm(
              "Enable editing — this will allow adding and deleting site content. Continue?"
            )
          ) {
            setEditMode(true);
          }
        });

        renderLists();

        // --- Create and wire a simple preview modal ---
        const modal = document.createElement("div");
        modal.id = "admin-view-modal";
        modal.innerHTML = `
          <div class="overlay" tabindex="-1"></div>
          <div class="dialog" role="dialog" aria-modal="true" aria-label="Content preview">
            <button class="closeBtn" aria-label="Close">Close</button>
            <img class="preview" src="" alt="preview image" />
            <div class="meta">
              <h3 class="title"></h3>
              <p class="desc"></p>
              <p class="extra"></p>
              <p style="margin-top:12px"><a class="externalLink button-like" href="#" target="_blank" rel="noopener" style="display:none">Open link</a></p>
            </div>
          </div>`;
        document.body.appendChild(modal);

        const viewModal = document.getElementById("admin-view-modal");
        const viewPreview = viewModal.querySelector("img.preview");
        const viewTitle = viewModal.querySelector(".title");
        const viewDesc = viewModal.querySelector(".desc");
        const viewExtra = viewModal.querySelector(".extra");
        const viewLink = viewModal.querySelector(".externalLink");
        const closeBtn = viewModal.querySelector(".closeBtn");

        function openViewModal(type, id) {
          let data = null;
          if (type === "service")
            data = App.getServices().find((s) => s.id === id);
          if (type === "testimonial")
            data = App.getTestimonials().find((t) => t.id === id);
          if (type === "project")
            data = App.getProjects().find((p) => p.id === id);
          if (!data) return alert("Item not found");
          viewTitle.textContent = data.title || data.name || "Preview";
          viewDesc.textContent = data.description || data.comment || "";
          viewExtra.textContent = data.role ? `Role: ${data.role}` : "";
          if (data.image) {
            viewPreview.src = data.image;
            viewPreview.style.display = "";
          } else {
            viewPreview.style.display = "none";
          }
          if (data.link) {
            viewLink.href = data.link;
            viewLink.style.display = "inline-block";
          } else {
            viewLink.style.display = "none";
          }
          viewModal.style.display = "flex";
          closeBtn.focus();
        }

        function closeViewModal() {
          viewModal.style.display = "none";
        }
        closeBtn.addEventListener("click", closeViewModal);
        viewModal
          .querySelector(".overlay")
          .addEventListener("click", closeViewModal);
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeViewModal();
        });

        // delegated click for view buttons
        document.body.addEventListener("click", (e) => {
          const btn = e.target.closest(".viewBtn");
          if (!btn) return;
          const type = btn.getAttribute("data-type");
          const id = Number(btn.getAttribute("data-id"));
          openViewModal(type, id);
        });
      });
    </script>
  </body>
</html>
